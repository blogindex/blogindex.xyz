#!/usr/bin/env bash
cd /blogindex.xyz/
echo "Cleaning .test virtual environment"${ci_opts}
rm -rf /blogindex.xyz/.test${ci_opts}
echo "Creating new .test virtual environment"${ci_opts}
python -m venv .test${ci_opts}
echo "Activating .test virtual environment"${ci_opts}
source .test/bin/activate${ci_opts}
echo "Install core requirements"${ci_opts}
pip install -qqq -r requirements.txt${ci_opts}
echo "Running Tests"${ci_opts}

if [ "${RUN_ON_CI}" = "drone" ]; then
    PYTHONPATH=. pytest --exitfirst -v --failed-first --cov . --cov-report html --capture=tee-sys${ci_opts}
    
    if [ -d "/drone/src/htmlcov" ]; then
        echo "Copying htmlcov to ${RESULTS}"${ci_opts}
        mv htmlcov "${RESULTS}"${ci_opts}
    fi
    if [ -d "${RESULTS}" ]; then
        echo "results are available at https://results.blogindex.dev/${RESULTS}"${ci_opts}
    else
        echo "An unknown error has occurred. Coverage Test Results are not available for this test."${ci_opts}
    fi
else
    pytest --exitfirst --verbose --failed-first --cov=. --cov-report html
fi